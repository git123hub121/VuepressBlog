---
title: 腾讯弹幕数据分析实战
date: 2020-12-22
tags:
  - Pandas
  - Pyecharts
  - 数据分析
---

# 腾讯弹幕数据分析实战

# 通用爬虫代码：

```python
'''
Date: 2020-12-21 23:27:59
LastEditTime: 2020-12-22 16:36:43
'''
import requests
import json
import time
import pandas as pd
  

def get_danmu_all_page(target_id, vid,filename):
    df = pd.DataFrame()
    for page in range(15, 20000, 30):  #亲测有效
        headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36'}
        url = 'https://mfm.video.qq.com/danmu?otype=json&timestamp={0}&target_id={1}vid{2}&count=80'.format(page,target_id,vid)
        print("正在提取第" + str(page) + "页")
        html = requests.get(url,headers = headers)
        bs = json.loads(html.text,strict = False)  #strict参数解决部分内容json格式解析报错
        time.sleep(0.5)
        #遍历获取目标字段
        try:
            for i in bs['comments']:
                opername = i['opername']
                content = i['content']  #弹幕
                upcount = i['upcount']  #点赞数
                user_degree =i['uservip_degree'] #会员等级
                timepoint = i['timepoint']  #发布时间
                comment_id = i['commentid']  #弹幕id
                cache = pd.DataFrame({'用户id':[opername],'弹幕':[content],'会员等级':[user_degree],'发布时间':[timepoint],'弹幕点赞':[upcount],'弹幕id':[comment_id]})
                df = pd.concat([df,cache])
        except Exception as e:
            break
    # df.to_csv(f'{filename}.csv',encoding = 'utf-8')
    return df
#自己按需添加
target_id = ['6130942571%26','6164313448%26','6194952391%26','6227063464%26']
vid = ['%3Dt0034o74jpr','%3Dr00346rvwyq','%3Dd0035rctvoh','%3Db0035j0tgo0']
filename = ['面试篇','第1期','第2期','第3期']
df = pd.DataFrame()
for i in range(len(vid)):
    df = get_danmu_all_page(target_id=target_id[i], vid=vid[i],filename=filename[i])#df{}.format(data_dm[i])
    df.insert(0, '所属期数', filename[i])
    df.to_csv(f'{filename[i]}.csv',index=False)

```


# 令人心动的offer2可视化分析


```python
import pandas as pd
import numpy as np
import pyecharts.options as opts
from pyecharts.charts import *
from pyecharts.globals import ThemeType
```

## 批量导入数据并合并


```python
# path = 'D:/Pandas/csv/'
# #文件目录路径
# df_all = pd.DataFrame()
# for i in os.listdir(path):
#     df_one = pd.read_csv(path+f'{i}', engine='python', encoding='utf-8')  
#     df_all = df_all.append(df_one, ignore_index=False)#ignore_index：默认值为False，如果为True则不使用index标签
# df_all.shape
# #输出
# df_all.to_excel('offer.xlsx',index=False)
```

## 数据读取


```python
df = pd.read_excel('offer.xlsx')
df[:10]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }

</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>所属期数</th>
      <th>用户id</th>
      <th>弹幕</th>
      <th>会员等级</th>
      <th>发布时间</th>
      <th>弹幕点赞</th>
      <th>弹幕id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>47，第一来了</td>
      <td>4</td>
      <td>5</td>
      <td>23</td>
      <td>6732257356663684096</td>
    </tr>
    <tr>
      <th>1</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>第一</td>
      <td>1</td>
      <td>8</td>
      <td>5</td>
      <td>6732257393620750336</td>
    </tr>
    <tr>
      <th>2</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>哈哈哈，我还以为我是第一个呢</td>
      <td>1</td>
      <td>7</td>
      <td>32</td>
      <td>6732257548063721472</td>
    </tr>
    <tr>
      <th>3</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>YEYEYEY</td>
      <td>0</td>
      <td>8</td>
      <td>16</td>
      <td>6732257672952315904</td>
    </tr>
    <tr>
      <th>4</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>来了来了，</td>
      <td>6</td>
      <td>6</td>
      <td>18</td>
      <td>6732258003787425792</td>
    </tr>
    <tr>
      <th>5</th>
      <td>第1期</td>
      <td>叶湘伦</td>
      <td>来了</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>6732258629720189952</td>
    </tr>
    <tr>
      <th>6</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>来了来了</td>
      <td>0</td>
      <td>8</td>
      <td>2</td>
      <td>6732258673319944192</td>
    </tr>
    <tr>
      <th>7</th>
      <td>第1期</td>
      <td>海浪</td>
      <td>来啦</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>6732258806970479616</td>
    </tr>
    <tr>
      <th>8</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>来咯</td>
      <td>0</td>
      <td>5</td>
      <td>4</td>
      <td>6732258885488543744</td>
    </tr>
    <tr>
      <th>9</th>
      <td>第1期</td>
      <td>熙崽是神仙</td>
      <td>第一！</td>
      <td>0</td>
      <td>7</td>
      <td>9</td>
      <td>6732260786762655744</td>
    </tr>
  </tbody>
</table>

</div>



## 数据处理及清洗

### 重命名

所属期数 episodes   用户id user     弹幕 comment    会员等级 grade  发布时间 date   弹幕点赞 likecounts     弹幕id dmid


```python
df.rename(columns={'所属期数':'episodes','用户id':'user','弹幕':'comment','会员等级':'grade','发布时间':'date','弹幕点赞':'likecounts','弹幕id':'dmid'},inplace=True)
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }

</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>episodes</th>
      <th>user</th>
      <th>comment</th>
      <th>grade</th>
      <th>date</th>
      <th>likecounts</th>
      <th>dmid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>47，第一来了</td>
      <td>4</td>
      <td>5</td>
      <td>23</td>
      <td>6732257356663684096</td>
    </tr>
    <tr>
      <th>1</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>第一</td>
      <td>1</td>
      <td>8</td>
      <td>5</td>
      <td>6732257393620750336</td>
    </tr>
    <tr>
      <th>2</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>哈哈哈，我还以为我是第一个呢</td>
      <td>1</td>
      <td>7</td>
      <td>32</td>
      <td>6732257548063721472</td>
    </tr>
    <tr>
      <th>3</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>YEYEYEY</td>
      <td>0</td>
      <td>8</td>
      <td>16</td>
      <td>6732257672952315904</td>
    </tr>
    <tr>
      <th>4</th>
      <td>第1期</td>
      <td>NaN</td>
      <td>来了来了，</td>
      <td>6</td>
      <td>6</td>
      <td>18</td>
      <td>6732258003787425792</td>
    </tr>
  </tbody>
</table>

</div>




```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 70798 entries, 0 to 70797
    Data columns (total 7 columns):
     #   Column      Non-Null Count  Dtype 
    ---  ------      --------------  ----- 
     0   episodes    70798 non-null  object
     1   user        26409 non-null  object
     2   comment     70797 non-null  object
     3   grade       70798 non-null  int64 
     4   date        70798 non-null  int64 
     5   likecounts  70798 non-null  int64 
     6   dmid        70798 non-null  int64 
    dtypes: int64(4), object(3)
    memory usage: 3.8+ MB


### 过滤字段


```python
#对用户进行空值补充
df['user'] = df['user'].fillna('未知用户')
#对弹幕进行re匹配处理
df['comment'] = df['comment'].str.extract(r"([\u4e00-\u9fa5]+)") #提取中文内容
df = df.dropna()  #纯表情弹幕直接删除
#提取分析字段
df = df.iloc[:,:-1]
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }

</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>episodes</th>
      <th>user</th>
      <th>comment</th>
      <th>grade</th>
      <th>date</th>
      <th>likecounts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>第1期</td>
      <td>未知用户</td>
      <td>第一来了</td>
      <td>4</td>
      <td>5</td>
      <td>23</td>
    </tr>
    <tr>
      <th>1</th>
      <td>第1期</td>
      <td>未知用户</td>
      <td>第一</td>
      <td>1</td>
      <td>8</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>第1期</td>
      <td>未知用户</td>
      <td>哈哈哈</td>
      <td>1</td>
      <td>7</td>
      <td>32</td>
    </tr>
    <tr>
      <th>4</th>
      <td>第1期</td>
      <td>未知用户</td>
      <td>来了来了</td>
      <td>6</td>
      <td>6</td>
      <td>18</td>
    </tr>
    <tr>
      <th>5</th>
      <td>第1期</td>
      <td>叶湘伦</td>
      <td>来了</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

</div>



### 时间格式转换


```python
def time_change(seconds):
    m, s = divmod(seconds, 60)
    h, m = divmod(m, 60)
    ss_time = "%d:%02d:%02d" % (h, m, s)
    # print(ss_time)
    return ss_time
# time_change(seconds=8888)
#将time_change函数应用于date字段：
df["date"] = df["date"].apply(time_change)
#设置为需要的时间格式
df['date'] = pd.to_datetime(df['date'])
df['date'] = df['date'].apply(lambda x : x.strftime('%H:%M:%S'))
```

### 机械压缩函数处理comment


```python
#定义机械压缩函数
def yasuo(st):
    for i in range(1,int(len(st)/2)+1):
        for j in range(len(st)):
            if st[j:j+i] == st[j+i:j+2*i]:
                k = j + i
                while st[k:k+i] == st[k+i:k+2*i] and k<len(st):   
                    k = k + i
                st = st[:j] + st[k:]    
    return st
# yasuo(st='')
#调用机械压缩函数
df["comment"] = df["comment"].astype("str").apply(yasuo)
```

### 会员等级打标


```python
df.grade.value_counts().index.tolist()
```




    [0, 3, 1, 4, 2, 5, 6, 7, 8]




```python
df['grade'] = 'v'+df['grade'].astype('str')#['v'+i for i in df['grade']]
```


```python
df.sample(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }

</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>episodes</th>
      <th>user</th>
      <th>comment</th>
      <th>grade</th>
      <th>date</th>
      <th>likecounts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9235</th>
      <td>第1期</td>
      <td>未知用户</td>
      <td>王颖飞好像一个演员</td>
      <td>v0</td>
      <td>00:27:42</td>
      <td>5</td>
    </tr>
    <tr>
      <th>57421</th>
      <td>面试篇</td>
      <td>zxz</td>
      <td>彩虹袜</td>
      <td>v3</td>
      <td>00:13:07</td>
      <td>12</td>
    </tr>
  </tbody>
</table>

</div>



## 数据分析


```python
#绘图通用函数
def get_pyechart(x,y,chart,title,size,pos,theme):
    if chart == 'bar':
        c = (
            Bar(init_opts=opts.InitOpts(theme=theme))
            .add_xaxis(x)
            .add_yaxis("",y) 
            .set_series_opts(label_opts=opts.LabelOpts(font_size=size,position=pos))
            )
    elif chart == 'barh':
        c = (
            Bar(init_opts=opts.InitOpts(theme=theme))
            .add_xaxis(x)
            .add_yaxis("",y).reversal_axis() #X轴与y轴调换顺序
            .set_series_opts(label_opts=opts.LabelOpts(font_size=size,position=pos))
            )
    elif chart == 'pie':
        c = (
            Pie(init_opts=opts.InitOpts(theme=theme))
            .add("", list(zip(x,y)))
            .set_series_opts(label_opts=opts.LabelOpts(formatter="等级{b}占比:{d}%",font_size=size))
            )
    elif chart == 'line':
        c = (
            Line(init_opts=opts.InitOpts(theme=theme))
            .add_xaxis(x)
            .add_yaxis('情感倾向',y, is_smooth=True,is_connect_nones=True,areastyle_opts=opts.AreaStyleOpts(opacity=0.5))
            .set_global_opts(title_opts=opts.TitleOpts(title=title,subtitle="数据来源：腾讯视频",pos_left = 'left'))
            )
    c.set_global_opts(title_opts=opts.TitleOpts(title=title,subtitle="数据来源：腾讯视频",pos_left = 'left'),
                        xaxis_opts=opts.AxisOpts(axislabel_opts=opts.LabelOpts(font_size=13)), #更改横坐标字体大小
                        yaxis_opts=opts.AxisOpts(axislabel_opts=opts.LabelOpts(font_size=13)), #更改纵坐标字体大小
                        )
    return c.render_notebook()
```

### 1.各期弹幕数量对比


```python
df_e = df['episodes'].value_counts()
df_e
```




    面试篇    18603
    第3期    18107
    第1期    17551
    第2期    15844
    Name: episodes, dtype: int64




```python
x = df_e.index.tolist()
y = df_e.values.tolist()
df_e = get_pyechart(x=x,y=y,chart='bar',title='各期弹幕数量',size=16,pos='top',theme=ThemeType.DARK)
df_e
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201222170017411.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzYwOTEy,size_16,color_FFFFFF,t_70)




<script>
    require.config({
        paths: {
            'echarts':'https://assets.pyecharts.org/assets/echarts.min'
        }
    });
</script>



<script>
        require(['echarts'], function(echarts) {
                var chart_f559d7f073444079a826b4bc4e61fbb4 = echarts.init(
                    document.getElementById('f559d7f073444079a826b4bc4e61fbb4'), 'dark', {renderer: 'canvas'});
                var option_f559d7f073444079a826b4bc4e61fbb4 = {
    "animation": true,
    "animationThreshold": 2000,
    "animationDuration": 1000,
    "animationEasing": "cubicOut",
    "animationDelay": 0,
    "animationDurationUpdate": 300,
    "animationEasingUpdate": "cubicOut",
    "animationDelayUpdate": 0,
    "series": [
        {
            "type": "bar",
            "legendHoverLink": true,
            "data": [
                18603,
                18107,
                17551,
                15844
            ],
            "showBackground": false,
            "barMinHeight": 0,
            "barCategoryGap": "20%",
            "barGap": "30%",
            "large": false,
            "largeThreshold": 400,
            "seriesLayoutBy": "column",
            "datasetIndex": 0,
            "clip": true,
            "zlevel": 0,
            "z": 2,
            "label": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 16
            },
            "rippleEffect": {
                "show": true,
                "brushType": "stroke",
                "scale": 2.5,
                "period": 4
            }
        }
    ],
    "legend": [
        {
            "data": [
                ""
            ],
            "selected": {
                "": true
            },
            "show": true,
            "padding": 5,
            "itemGap": 10,
            "itemWidth": 25,
            "itemHeight": 14
        }
    ],
    "tooltip": {
        "show": true,
        "trigger": "item",
        "triggerOn": "mousemove|click",
        "axisPointer": {
            "type": "line"
        },
        "showContent": true,
        "alwaysShowContent": false,
        "showDelay": 0,
        "hideDelay": 100,
        "textStyle": {
            "fontSize": 14
        },
        "borderWidth": 0,
        "padding": 5
    },
    "xAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            },
            "data": [
                "\u9762\u8bd5\u7bc7",
                "\u7b2c3\u671f",
                "\u7b2c1\u671f",
                "\u7b2c2\u671f"
            ]
        }
    ],
    "yAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            }
        }
    ],
    "title": [
        {
            "text": "\u5404\u671f\u5f39\u5e55\u6570\u91cf",
            "subtext": "\u6570\u636e\u6765\u6e90\uff1a\u817e\u8baf\u89c6\u9891",
            "left": "left",
            "padding": 5,
            "itemGap": 10
        }
    ]
};
                chart_f559d7f073444079a826b4bc4e61fbb4.setOption(option_f559d7f073444079a826b4bc4e61fbb4);
        });
    </script>






### 2.谁是弹幕发射机


```python
df_u = df['user'].value_counts()[1:10].sort_values(ascending=True)
df_u
```




    神马不是浮云     78
    .          79
    圣雪天使       80
    。          89
    白龙吟        92
    为时不晚i      93
    momo       93
    ベ☆小强呐     103
    想太多de猫    135
    Name: user, dtype: int64




```python
x = df_u.index.tolist()
y = df_u.values.tolist()
df_u = get_pyechart(x=x,y=y,chart='barh',title='弹幕发送数量TOP10',size=16,pos='right',theme=ThemeType.DARK)
df_u
```


![在这里插入图片描述](https://img-blog.csdnimg.cn/20201222165950490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzYwOTEy,size_16,color_FFFFFF,t_70)



<script>
    require.config({
        paths: {
            'echarts':'https://assets.pyecharts.org/assets/echarts.min'
        }
    });
</script>




<script>
        require(['echarts'], function(echarts) {
                var chart_149db93964114a8581bf54a6f79848a1 = echarts.init(
                    document.getElementById('149db93964114a8581bf54a6f79848a1'), 'dark', {renderer: 'canvas'});
                var option_149db93964114a8581bf54a6f79848a1 = {
    "animation": true,
    "animationThreshold": 2000,
    "animationDuration": 1000,
    "animationEasing": "cubicOut",
    "animationDelay": 0,
    "animationDurationUpdate": 300,
    "animationEasingUpdate": "cubicOut",
    "animationDelayUpdate": 0,
    "series": [
        {
            "type": "bar",
            "legendHoverLink": true,
            "data": [
                78,
                79,
                80,
                89,
                92,
                93,
                93,
                103,
                135
            ],
            "showBackground": false,
            "barMinHeight": 0,
            "barCategoryGap": "20%",
            "barGap": "30%",
            "large": false,
            "largeThreshold": 400,
            "seriesLayoutBy": "column",
            "datasetIndex": 0,
            "clip": true,
            "zlevel": 0,
            "z": 2,
            "label": {
                "show": true,
                "position": "right",
                "margin": 8,
                "fontSize": 16
            },
            "rippleEffect": {
                "show": true,
                "brushType": "stroke",
                "scale": 2.5,
                "period": 4
            }
        }
    ],
    "legend": [
        {
            "data": [
                ""
            ],
            "selected": {
                "": true
            },
            "show": true,
            "padding": 5,
            "itemGap": 10,
            "itemWidth": 25,
            "itemHeight": 14
        }
    ],
    "tooltip": {
        "show": true,
        "trigger": "item",
        "triggerOn": "mousemove|click",
        "axisPointer": {
            "type": "line"
        },
        "showContent": true,
        "alwaysShowContent": false,
        "showDelay": 0,
        "hideDelay": 100,
        "textStyle": {
            "fontSize": 14
        },
        "borderWidth": 0,
        "padding": 5
    },
    "xAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            }
        }
    ],
    "yAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            },
            "data": [
                "\u795e\u9a6c\u4e0d\u662f\u6d6e\u4e91",
                ".",
                "\u5723\u96ea\u5929\u4f7f",
                "\u3002",
                "\u767d\u9f99\u541f",
                "\u4e3a\u65f6\u4e0d\u665ai",
                "momo",
                "\u30d9\u2606\u5c0f\u5f3a\u5450",
                "\u60f3\u592a\u591ade\u732b"
            ]
        }
    ],
    "title": [
        {
            "text": "\u5f39\u5e55\u53d1\u9001\u6570\u91cfTOP10",
            "subtext": "\u6570\u636e\u6765\u6e90\uff1a\u817e\u8baf\u89c6\u9891",
            "left": "left",
            "padding": 5,
            "itemGap": 10
        }
    ]
};
                chart_149db93964114a8581bf54a6f79848a1.setOption(option_149db93964114a8581bf54a6f79848a1);
        });
    </script>






```python
df[df["user"]=="想太多de猫"].sample(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }

</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>episodes</th>
      <th>user</th>
      <th>comment</th>
      <th>grade</th>
      <th>date</th>
      <th>likecounts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17104</th>
      <td>第1期</td>
      <td>想太多de猫</td>
      <td>爱吃辣的都是美女</td>
      <td>v4</td>
      <td>00:51:54</td>
      <td>9</td>
    </tr>
    <tr>
      <th>20881</th>
      <td>第2期</td>
      <td>想太多de猫</td>
      <td>如果这都是咸鱼</td>
      <td>v4</td>
      <td>00:09:45</td>
      <td>10</td>
    </tr>
    <tr>
      <th>1489</th>
      <td>第1期</td>
      <td>想太多de猫</td>
      <td>领带神马的太高端</td>
      <td>v4</td>
      <td>00:04:42</td>
      <td>12</td>
    </tr>
    <tr>
      <th>5408</th>
      <td>第1期</td>
      <td>想太多de猫</td>
      <td>谦虚不等于诚实哦</td>
      <td>v4</td>
      <td>00:15:49</td>
      <td>12</td>
    </tr>
    <tr>
      <th>57919</th>
      <td>面试篇</td>
      <td>想太多de猫</td>
      <td>大多数父母的想法</td>
      <td>v4</td>
      <td>00:14:54</td>
      <td>7</td>
    </tr>
    <tr>
      <th>60506</th>
      <td>面试篇</td>
      <td>想太多de猫</td>
      <td>越看越自卑</td>
      <td>v4</td>
      <td>00:21:36</td>
      <td>13</td>
    </tr>
    <tr>
      <th>45714</th>
      <td>第3期</td>
      <td>想太多de猫</td>
      <td>这是绝对的高质量对抗</td>
      <td>v0</td>
      <td>00:37:00</td>
      <td>2</td>
    </tr>
    <tr>
      <th>21397</th>
      <td>第2期</td>
      <td>想太多de猫</td>
      <td>瞿泽林这句对人性的关怀</td>
      <td>v4</td>
      <td>00:11:05</td>
      <td>49</td>
    </tr>
    <tr>
      <th>59906</th>
      <td>面试篇</td>
      <td>想太多de猫</td>
      <td>假发了解一下</td>
      <td>v4</td>
      <td>00:19:53</td>
      <td>13</td>
    </tr>
    <tr>
      <th>39564</th>
      <td>第3期</td>
      <td>想太多de猫</td>
      <td>个人觉得直接问更好</td>
      <td>v0</td>
      <td>00:21:49</td>
      <td>1</td>
    </tr>
  </tbody>
</table>

</div>



### 3.会员等级分布


```python
df_g = df['grade'].value_counts().sort_values(ascending=True)
df_g
```




    v8       12
    v7      135
    v6     1496
    v5     2097
    v2     2499
    v4     2957
    v1     3220
    v3     3403
    v0    54286
    Name: grade, dtype: int64




```python
x = df_g.index.tolist()
y = df_g.values.tolist()
df_g = get_pyechart(x=x,y=y,chart='pie',title='会员等级分布',size=14,pos='right',theme=ThemeType.DARK)
df_g
```


![在这里插入图片描述](https://img-blog.csdnimg.cn/20201222165917851.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzYwOTEy,size_16,color_FFFFFF,t_70)



<script>
    require.config({
        paths: {
            'echarts':'https://assets.pyecharts.org/assets/echarts.min'
        }
    });
</script>


  

<script>
        require(['echarts'], function(echarts) {
                var chart_5e76e537efd74f428eb6a3adc877fe3a = echarts.init(
                    document.getElementById('5e76e537efd74f428eb6a3adc877fe3a'), 'dark', {renderer: 'canvas'});
                var option_5e76e537efd74f428eb6a3adc877fe3a = {
    "animation": true,
    "animationThreshold": 2000,
    "animationDuration": 1000,
    "animationEasing": "cubicOut",
    "animationDelay": 0,
    "animationDurationUpdate": 300,
    "animationEasingUpdate": "cubicOut",
    "animationDelayUpdate": 0,
    "series": [
        {
            "type": "pie",
            "clockwise": true,
            "data": [
                {
                    "name": "v8",
                    "value": 12
                },
                {
                    "name": "v7",
                    "value": 135
                },
                {
                    "name": "v6",
                    "value": 1496
                },
                {
                    "name": "v5",
                    "value": 2097
                },
                {
                    "name": "v2",
                    "value": 2499
                },
                {
                    "name": "v4",
                    "value": 2957
                },
                {
                    "name": "v1",
                    "value": 3220
                },
                {
                    "name": "v3",
                    "value": 3403
                },
                {
                    "name": "v0",
                    "value": 54286
                }
            ],
            "radius": [
                "0%",
                "75%"
            ],
            "center": [
                "50%",
                "50%"
            ],
            "label": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 14,
                "formatter": "\u7b49\u7ea7{b}\u5360\u6bd4:{d}%"
            },
            "rippleEffect": {
                "show": true,
                "brushType": "stroke",
                "scale": 2.5,
                "period": 4
            }
        }
    ],
    "legend": [
        {
            "data": [
                "v8",
                "v7",
                "v6",
                "v5",
                "v2",
                "v4",
                "v1",
                "v3",
                "v0"
            ],
            "selected": {},
            "show": true,
            "padding": 5,
            "itemGap": 10,
            "itemWidth": 25,
            "itemHeight": 14
        }
    ],
    "tooltip": {
        "show": true,
        "trigger": "item",
        "triggerOn": "mousemove|click",
        "axisPointer": {
            "type": "line"
        },
        "showContent": true,
        "alwaysShowContent": false,
        "showDelay": 0,
        "hideDelay": 100,
        "textStyle": {
            "fontSize": 14
        },
        "borderWidth": 0,
        "padding": 5
    },
    "title": [
        {
            "text": "\u4f1a\u5458\u7b49\u7ea7\u5206\u5e03",
            "subtext": "\u6570\u636e\u6765\u6e90\uff1a\u817e\u8baf\u89c6\u9891",
            "left": "left",
            "padding": 5,
            "itemGap": 10
        }
    ]
};
                chart_5e76e537efd74f428eb6a3adc877fe3a.setOption(option_5e76e537efd74f428eb6a3adc877fe3a);
        });
    </script>





### 词云图讨论


```python
import stylecloud
import jieba
import os 
from IPython.display import Image # 用于在jupyter lab中显示本地图
```


```python
# 定义分词函数
def get_cut_words(content_series):
    # 读入停用词表
    stop_words = [] 
    with open(r"D:/Pandas/已学习/如何制作stylecloud词云？/stop_words.txt", 'r', encoding='utf-8') as f:
        lines = f.readlines()
        for line in lines:
            stop_words.append(line.strip())
    # 添加关键词
    my_words = ['撒老师', '范丞丞','第一季']  
    for i in my_words:
        jieba.add_word(i) 
    # 自定义停用词
    my_stop_words = ['好像', '真的','感觉']   
    stop_words.extend(my_stop_words)               
    # 分词
    word_num = jieba.lcut(content_series.str.cat(sep='。'), cut_all=False)
    # 条件筛选
    word_num_selected = [i for i in word_num if i not in stop_words and len(i)>=2]
    return word_num_selected
# 绘制词云图
text1 = get_cut_words(content_series=df['comment'])
stylecloud.gen_stylecloud(text=' '.join(text1), max_words=100,
                          collocations=False,
                          font_path='字酷堂清楷体.ttf',
                          icon_name='fas fa-dog',
                          size=512,
                          #palette='matplotlib.Inferno_9',
                          output_name='offer.png')
Image(filename='offer.png')
```

    Building prefix dict from the default dictionary ...
    Loading model from cache C:\Users\ADMINI~1\AppData\Local\Temp\jieba.cache
    Loading model cost 2.044 seconds.
    Prefix dict has been built successfully.

![\[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-PL3JJJhN-1608626592533)(demo-offer_files/demo-offer_39_1.png)\]](https://img-blog.csdnimg.cn/20201222165827726.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzYwOTEy,size_16,color_FFFFFF,t_70)




### 4.人物被提及

丁辉,詹秋怡,王骁,朱一暄,瞿泽林,李晋晔,王颖飞,刘煜成


```python
#df.str.contains('')虽然不能用来判断，但是可以进行聚合操作
df_talk = ['丁辉','詹秋怡','王骁','朱一暄','瞿泽林','李晋晔','王颖飞','刘煜成']
dft = [df['comment'].str.contains(i).sum() for i in df_talk]
df_t = pd.DataFrame(data={'people':df_talk,'count':dft})
df_t = df_t.sort_values('count',ascending=False)
x = df_t['people'].tolist()
y = df_t['count'].tolist()
df_t = get_pyechart(x=x,y=y,chart='bar',title='被提及次数',size=16,pos='top',theme=ThemeType.DARK)
df_t
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20201222165725284.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzYwOTEy,size_16,color_FFFFFF,t_70)





<script>
    require.config({
        paths: {
            'echarts':'https://assets.pyecharts.org/assets/echarts.min'
        }
    });
</script>


 

<script>
        require(['echarts'], function(echarts) {
                var chart_6f1d8978b2aa413abb27794eca45b9da = echarts.init(
                    document.getElementById('6f1d8978b2aa413abb27794eca45b9da'), 'dark', {renderer: 'canvas'});
                var option_6f1d8978b2aa413abb27794eca45b9da = {
    "animation": true,
    "animationThreshold": 2000,
    "animationDuration": 1000,
    "animationEasing": "cubicOut",
    "animationDelay": 0,
    "animationDurationUpdate": 300,
    "animationEasingUpdate": "cubicOut",
    "animationDelayUpdate": 0,
    "series": [
        {
            "type": "bar",
            "legendHoverLink": true,
            "data": [
                2772,
                1569,
                481,
                314,
                276,
                241,
                205,
                109
            ],
            "showBackground": false,
            "barMinHeight": 0,
            "barCategoryGap": "20%",
            "barGap": "30%",
            "large": false,
            "largeThreshold": 400,
            "seriesLayoutBy": "column",
            "datasetIndex": 0,
            "clip": true,
            "zlevel": 0,
            "z": 2,
            "label": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 16
            },
            "rippleEffect": {
                "show": true,
                "brushType": "stroke",
                "scale": 2.5,
                "period": 4
            }
        }
    ],
    "legend": [
        {
            "data": [
                ""
            ],
            "selected": {
                "": true
            },
            "show": true,
            "padding": 5,
            "itemGap": 10,
            "itemWidth": 25,
            "itemHeight": 14
        }
    ],
    "tooltip": {
        "show": true,
        "trigger": "item",
        "triggerOn": "mousemove|click",
        "axisPointer": {
            "type": "line"
        },
        "showContent": true,
        "alwaysShowContent": false,
        "showDelay": 0,
        "hideDelay": 100,
        "textStyle": {
            "fontSize": 14
        },
        "borderWidth": 0,
        "padding": 5
    },
    "xAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            },
            "data": [
                "\u4e01\u8f89",
                "\u738b\u9a81",
                "\u6731\u4e00\u6684",
                "\u674e\u664b\u6654",
                "\u738b\u9896\u98de",
                "\u5218\u715c\u6210",
                "\u8a79\u79cb\u6021",
                "\u77bf\u6cfd\u6797"
            ]
        }
    ],
    "yAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            }
        }
    ],
    "title": [
        {
            "text": "\u88ab\u63d0\u53ca\u6b21\u6570",
            "subtext": "\u6570\u636e\u6765\u6e90\uff1a\u817e\u8baf\u89c6\u9891",
            "left": "left",
            "padding": 5,
            "itemGap": 10
        }
    ]
};
                chart_6f1d8978b2aa413abb27794eca45b9da.setOption(option_6f1d8978b2aa413abb27794eca45b9da);
        });
    </script>





### 情感分析


```python
import paddlehub as hub
#这里使用了百度开源的成熟NLP模型来预测情感倾向
senta = hub.Module(name="senta_bilstm")
texts = df['comment'].tolist()
input_data = {'text':texts}
res = senta.sentiment_classify(data=input_data)
df['pos'] = [x['positive_probs'] for x in res]
#重采样至15分钟
df.index = pd.to_datetime(df['date'])
data = df.resample('15min').mean().reset_index()

# #给数据表添加调色板
# import seaborn as sns
# color_map = sns.light_palette('orange', as_cmap=True)  #light_palette调色板
# data.style.background_gradient(color_map)
```

    [2020-12-22 16:27:46,410] [    INFO] - Installing senta_bilstm module
    [2020-12-22 16:27:46,436] [    INFO] - Module senta_bilstm already installed in C:\Users\Administrator\.paddlehub\modules\senta_bilstm
    [2020-12-22 16:27:57,111] [    INFO] - Installing lac module
    [2020-12-22 16:27:57,579] [    INFO] - Module lac already installed in C:\Users\Administrator\.paddlehub\modules\lac



```python
df[:10]
```


```python
x = data["date"].to_list()
y = list(data["pos"].round(2))
df_p = get_pyechart(x=x,y=y,chart='line',title='情感倾向',size=16,pos='top',theme=ThemeType.DARK)
df_p
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201222170041469.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzYwOTEy,size_16,color_FFFFFF,t_70)

```js
<script>
    require.config({
        paths: {
            'echarts':'https://assets.pyecharts.org/assets/echarts.min'
        }
    });
</script>
```

```js
<script>
        require(['echarts'], function(echarts) {
                var chart_34cdda93fa8a4c00b8eb1ab935752ca3 = echarts.init(
                    document.getElementById('34cdda93fa8a4c00b8eb1ab935752ca3'), 'dark', {renderer: 'canvas'});
                var option_34cdda93fa8a4c00b8eb1ab935752ca3 = {
    "animation": true,
    "animationThreshold": 2000,
    "animationDuration": 1000,
    "animationEasing": "cubicOut",
    "animationDelay": 0,
    "animationDurationUpdate": 300,
    "animationEasingUpdate": "cubicOut",
    "animationDelayUpdate": 0,
    "series": [
        {
            "type": "line",
            "name": "\u60c5\u611f\u503e\u5411",
            "connectNulls": true,
            "symbolSize": 4,
            "showSymbol": true,
            "smooth": true,
            "clip": true,
            "step": false,
            "data": [
                [
                    "2020-12-22T00:00:00",
                    0.66
                ],
                [
                    "2020-12-22T00:15:00",
                    0.6
                ],
                [
                    "2020-12-22T00:30:00",
                    0.55
                ],
                [
                    "2020-12-22T00:45:00",
                    0.55
                ]
            ],
            "hoverAnimation": true,
            "label": {
                "show": true,
                "position": "top",
                "margin": 8
            },
            "lineStyle": {
                "show": true,
                "width": 1,
                "opacity": 1,
                "curveness": 0,
                "type": "solid"
            },
            "areaStyle": {
                "opacity": 0.5
            },
            "zlevel": 0,
            "z": 0
        }
    ],
    "legend": [
        {
            "data": [
                "\u60c5\u611f\u503e\u5411"
            ],
            "selected": {
                "\u60c5\u611f\u503e\u5411": true
            },
            "show": true,
            "padding": 5,
            "itemGap": 10,
            "itemWidth": 25,
            "itemHeight": 14
        }
    ],
    "tooltip": {
        "show": true,
        "trigger": "item",
        "triggerOn": "mousemove|click",
        "axisPointer": {
            "type": "line"
        },
        "showContent": true,
        "alwaysShowContent": false,
        "showDelay": 0,
        "hideDelay": 100,
        "textStyle": {
            "fontSize": 14
        },
        "borderWidth": 0,
        "padding": 5
    },
    "xAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            },
            "data": [
                "2020-12-22T00:00:00",
                "2020-12-22T00:15:00",
                "2020-12-22T00:30:00",
                "2020-12-22T00:45:00"
            ]
        }
    ],
    "yAxis": [
        {
            "show": true,
            "scale": false,
            "nameLocation": "end",
            "nameGap": 15,
            "gridIndex": 0,
            "axisLabel": {
                "show": true,
                "position": "top",
                "margin": 8,
                "fontSize": 13
            },
            "inverse": false,
            "offset": 0,
            "splitNumber": 5,
            "minInterval": 0,
            "splitLine": {
                "show": false,
                "lineStyle": {
                    "show": true,
                    "width": 1,
                    "opacity": 1,
                    "curveness": 0,
                    "type": "solid"
                }
            }
        }
    ],
    "title": [
        {
            "text": "\u60c5\u611f\u503e\u5411",
            "subtext": "\u6570\u636e\u6765\u6e90\uff1a\u817e\u8baf\u89c6\u9891",
            "left": "left",
            "padding": 5,
            "itemGap": 10
        }
    ]
};
                chart_34cdda93fa8a4c00b8eb1ab935752ca3.setOption(option_34cdda93fa8a4c00b8eb1ab935752ca3);
        });
    </script>
```

# 数据集：

链接：[https://pan.baidu.com/s/1p4O8-SF-IVqnJkH-5Fp3jw 
](https://pan.baidu.com/s/1p4O8-SF-IVqnJkH-5Fp3jw)提取码：love 
复制这段内容后打开百度网盘手机App，操作更方便哦

# 总结
情感分析会比较耗时间



